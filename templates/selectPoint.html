<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TSS - TreeSense ShortestPath - Select Points</title>
    <style>
      :root{
        --bg:#0b0f0a; /* near-black */
        --panel:#07120b; /* deeper black */
        --accent:#14b06b; /* bright green */
        --muted:#0f3b2a; /* darker green */
        --text:#cfeee0; /* pale green text */
        --muted-text:#9ccfb7;
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(180deg,var(--bg),#041209);
        color:var(--text);
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
        padding:20px;
      }
      .wrap{
        max-width:1100px;
        margin:0 auto;
        display:grid;
        grid-template-columns:1fr 360px;
        gap:20px;
        align-items:start;
      }
      @media (max-width:900px){
        .wrap{grid-template-columns:1fr; padding:0 10px}
      }
      header{display:flex;align-items:center;gap:12px;margin-bottom:6px}
      header h1{font-size:1.05rem;margin:0;font-weight:600;color:var(--accent)}
      header p{margin:0;color:var(--muted-text);font-size:0.9rem}

      .canvas-card{
        background:linear-gradient(180deg, rgba(20,176,107,0.04), rgba(0,0,0,0.05));
        border-radius:10px;
        padding:12px;
        box-shadow:0 6px 18px rgba(0,0,0,0.6);
        border:1px solid rgba(20,176,107,0.06);
      }
      .canvas-wrap{
        width:100%;
        display:flex;
        justify-content:center;
        align-items:center;
        overflow:auto;
        background:var(--panel);
        border-radius:6px;
        padding:8px;
      }
      canvas{
        background:transparent;
        max-width:100%;
        height:auto; /* allow CSS scaling while keeping internal resolution */
        display:block;
        border-radius:3px;
        touch-action:manipulation;
        image-rendering: pixelated;
        cursor:crosshair;
      }

      .sidebar{
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
        padding:14px;
        border-radius:10px;
        border:1px solid rgba(20,176,107,0.06);
        color:var(--muted-text);
      }
      label{display:block;margin-bottom:8px;color:var(--text);font-weight:600}
      .hint{font-size:0.92rem;margin:6px 0 12px;color:var(--muted-text)}

      .legend{display:flex;gap:12px;align-items:center;margin-bottom:8px}
      .swatch{width:18px;height:18px;border-radius:4px;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.03)}
      .swatch.start{background:magenta}
      .swatch.goal{background:yellow}

      .coords{font-family:monospace;background:rgba(0,0,0,0.25);padding:8px;border-radius:6px;color:var(--muted-text);margin-bottom:10px}

      input[type="number"]{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
      .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(180deg,var(--accent),#0ea060);color:#03120b;font-weight:700;cursor:pointer;margin-top:8px}
      .btn:active{transform:translateY(1px)}
      .muted-note{font-size:0.86rem;color:var(--muted-text);margin-top:8px}

      footer{margin-top:12px;font-size:0.82rem;color:var(--muted-text)}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div>
        <header>
          <div>
            <h1>Select Start then Goal</h1>
            <p>Click once for Start, then once for Goal — coordinates appear and are submitted to the server.</p>
          </div>
        </header>

        <section class="canvas-card">
          <div class="canvas-wrap" aria-hidden="false">
            <canvas id="cnv" role="img" aria-label="Map canvas"></canvas>
          </div>
          <div class="hint">Tap the canvas to place points. Use two taps: first sets Start (magenta), second sets Goal (yellow). On small screens, pinch/scroll to view.</div>
        </section>
      </div>

      <aside class="sidebar">
        <div class="legend">
          <div style="flex:1">
            <div class="swatch start" aria-hidden></div> <small style="vertical-align:middle;margin-left:6px">Start (magenta)</small>
          </div>
          <div style="flex:1">
            <div class="swatch goal" aria-hidden></div> <small style="vertical-align:middle;margin-left:6px">Goal (yellow)</small>
          </div>
        </div>

        <div id="coords" class="coords">Start: -, Goal: -</div>

        <form id="goForm" method="post" action="/start">
          <input type="hidden" name="jobId" value="{{ jobId }}">
          <input type="hidden" name="startY" id="startY">
          <input type="hidden" name="startX" id="startX">
          <input type="hidden" name="goalY" id="goalY">
          <input type="hidden" name="goalX" id="goalX">

          <label for="expansionsPerFrame">Expansions per frame</label>
          <input id="expansionsPerFrame" type="number" name="expansionsPerFrame" value="25" min="1" max="200">

          <button class="btn" type="submit">Run</button>
          <div class="muted-note">Tip: Lower expansions for smoother animation on mobile.</div>
        </form>

        <footer>Image source: <code>/image/{{ jobId }}/base.png</code></footer>
      </aside>
    </div>

    <script>
      const jobId = "{{ jobId }}";
      const imgUrl = "/image/" + jobId + "/base.png";
      const cnv = document.getElementById("cnv");
      const ctx = cnv.getContext("2d");
      const coordsDiv = document.getElementById("coords");
      const startY = document.getElementById("startY");
      const startX = document.getElementById("startX");
      const goalY = document.getElementById("goalY");
      const goalX = document.getElementById("goalX");
      let clicks = [];
      const img = new Image();

      // When the image loads we set the canvas internal resolution to the image's natural size
      // and draw it once. We intentionally set the canvas internal width/height so that
      // all internal coordinates are based on the image pixels. The canvas may be displayed
      // smaller via CSS for responsiveness — click coordinates are mapped accordingly below.
      img.onload = () => { cnv.width = img.width; cnv.height = img.height; ctx.drawImage(img,0,0); };
      img.src = imgUrl;

      function drawMarkers() {
        // redraw base image at internal resolution
        ctx.clearRect(0,0,cnv.width,cnv.height);
        ctx.drawImage(img,0,0);
        if (clicks[0]) {
          ctx.fillStyle = "magenta";
          ctx.fillRect(clicks[0].x-4, clicks[0].y-4, 9, 9);
          // small halo
          ctx.strokeStyle = "rgba(255,0,255,0.15)";
          ctx.lineWidth = 2;
          ctx.strokeRect(clicks[0].x-6, clicks[0].y-6, 13, 13);
        }
        if (clicks[1]) {
          ctx.fillStyle = "yellow";
          ctx.fillRect(clicks[1].x-4, clicks[1].y-4, 9, 9);
          ctx.strokeStyle = "rgba(255,255,0,0.12)";
          ctx.lineWidth = 2;
          ctx.strokeRect(clicks[1].x-6, clicks[1].y-6, 13, 13);
        }
      }

      // Map pointer event coordinates (relative to displayed size) to the canvas's internal pixel coordinates.
      cnv.addEventListener("click", (e) => {
        const rect = cnv.getBoundingClientRect();
        // account for CSS scaling: map from displayed pixels to canvas internal pixels
        const scaleX = cnv.width / rect.width;
        const scaleY = cnv.height / rect.height;
        const x = Math.round((e.clientX - rect.left) * scaleX);
        const y = Math.round((e.clientY - rect.top) * scaleY);
        if (clicks.length < 2) { clicks.push({x, y}); } else { clicks = [{x, y}]; }
        drawMarkers();
        if (clicks[0]) { startY.value = clicks[0].y; startX.value = clicks[0].x; }
        if (clicks[1]) { goalY.value = clicks[1].y; goalX.value = clicks[1].x; }
        coordsDiv.textContent = "Start: " + (clicks[0] ? clicks[0].y + "," + clicks[0].x : "-") +
                                " | Goal: " + (clicks[1] ? clicks[1].y + "," + clicks[1].x : "-");
      });

      // If the window resizes we should re-draw (display size may change)
      window.addEventListener('resize', () => {
        // Only redraw if image already loaded
        if (img.complete) drawMarkers();
      });
    </script>
  </body>
</html>
